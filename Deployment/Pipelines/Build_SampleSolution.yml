name: $(Major).$(Minor)$(Rev:.r)

variables:
- group: Versioning

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
    - job: Build
      displayName: 'Build Sample Solution'
      pool:
        vmImage: 'windows-latest'
      variables:
      - name: BuildPlatform
        value: 'Any CPU'
      - name: BuildConfiguration
        value: 'Release'

      steps:
      - checkout: self
        clean: true
        persistCredentials: true

      - task: PowerShell@2
        inputs:
          filePath: 'Deployment/Scripts/CreateAppSettings.ps1'
          arguments: ''
      
      - template: 'Template_Build.yml'
        parameters:
          solutions: '**\\*.sln'
      
      - task: PowerShell@2
        inputs:
          filePath: 'Deployment/Scripts/FindSpecRunFolder.ps1'
          arguments: ''
      
      - task: CopyFiles@2
        displayName: 'Copy Sample Project'
        inputs:
          SourceFolder: '$(system.defaultworkingdirectory)'
          Contents: '**\Vermaat.Crm.Specflow.Sample\bin\$(BuildConfiguration)\**'
          TargetFolder: '$(build.artifactstagingdirectory)\SpecFlow'
          flattenFolders: true
      
      - task: CopyFiles@2
        displayName: 'Copy Solution File'
        inputs:
          SourceFolder: '$(system.defaultworkingdirectory)\Deployment\Solutions'
          Contents: '**'
          TargetFolder: '$(build.artifactstagingdirectory)\Solution'
      
      - task: CopyFiles@2
        displayName: 'Copy SpecRun'
        inputs:
          SourceFolder: '$(SpecRunFolder)\tools'
          TargetFolder: '$(build.artifactstagingdirectory)\SpecFlow\SpecFlowPlusRunner'
      
      - task: SpecFlowPlus@0
        displayName: 'SpecFlow+ Documentation'
        inputs:
          projectFilePath: Vermaat.Crm.Specflow.Sample/Vermaat.Crm.Specflow.Sample.csproj
          projectName: 'SpecFlow Demo'
          projectLanguage: en
      
      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifact'
        inputs:
          PathtoPublish: '$(build.artifactstagingdirectory)'
          ArtifactName: SampleSolution

- stage: Deploy
  displayName: 'Deployment Stage'
  jobs:
  - deployment: 'Deployment'
    displayName: 'Deploy Sample Solution'
    timeoutInMinutes: 600
    pool:
      vmImage: 'windows-latest'
    variables:
    - group: 'TST'
    environment: 'TST'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: MSCRMToolInstaller@9
            displayName: 'MSCRM Tool Installer'